{% extends 'base.html' %}

{% block title %}Admin - UpTriv{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <h1>Admin Dashboard</h1>
        <p class="admin-subtitle">Site analytics and user management</p>
    </div>

    <!-- Stats Overview -->
    <div class="stats-overview">
        <div class="stat-box">
            <div class="stat-value">{{ today_visits }}</div>
            <div class="stat-label">Today's Visits</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">{{ today_unique }}</div>
            <div class="stat-label">Unique Today</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">{{ total_visits }}</div>
            <div class="stat-label">Total Visits</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">{{ total_unique }}</div>
            <div class="stat-label">Unique Visitors</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">{{ total_users }}</div>
            <div class="stat-label">Registered Users</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">{{ google_users }}</div>
            <div class="stat-label">Google Users</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">{{ total_games }}</div>
            <div class="stat-label">Games Played</div>
        </div>
    </div>

    <div class="admin-grid">
        <!-- Daily Stats -->
        <div class="admin-card">
            <h2>Last 7 Days</h2>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Visits</th>
                        <th>Unique</th>
                    </tr>
                </thead>
                <tbody>
                    {% for day in daily_stats %}
                    <tr>
                        <td>{{ day.date }}</td>
                        <td>{{ day.visits }}</td>
                        <td>{{ day.unique_visitors }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Page Visits -->
        <div class="admin-card">
            <h2>Top Pages</h2>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Page</th>
                        <th>Visits</th>
                    </tr>
                </thead>
                <tbody>
                    {% for page in page_visits %}
                    <tr>
                        <td>{{ page.path }}</td>
                        <td>{{ page.count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Admin Actions -->
        <div class="admin-card">
            <h2>Admin Actions</h2>
            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">
                Flush cached questions to force regeneration. Use this if today's questions have issues.
            </p>
            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                <button onclick="flushQuestions('easy')" class="flush-btn flush-easy">Flush Normal Questions</button>
                <button onclick="flushQuestions('hard')" class="flush-btn flush-hard">Flush Expert Questions</button>
                <button onclick="flushQuestions('all')" class="flush-btn flush-all">Flush All Questions</button>
            </div>
            <div id="flush-result" style="margin-top: 1rem; font-size: 0.85rem; display: none;"></div>
        </div>

        <!-- Preview Tomorrow's Questions -->
        <div class="admin-card" style="grid-column: 1 / -1;">
            <h2>Preview Future Questions</h2>
            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">
                Generate and preview questions for a future date. Read-only â€” nothing is cached or saved.
            </p>
            <div style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;">
                <input type="date" id="preview-date" class="preview-date-input">
                <button onclick="previewQuestions()" class="flush-btn" style="background: #10b981; color: white;">Preview Questions</button>
            </div>
            <div id="preview-result" style="margin-top: 1.5rem; display: none;">
                <p id="preview-date-label" style="font-weight: 600; margin-bottom: 1rem;"></p>
                <div id="preview-sections"></div>
            </div>
        </div>

        <!-- Today's Logins -->
        <div class="admin-card">
            <h2>Active Users Today ({{ today_logins|length }})</h2>
            {% if today_logins %}
            <div class="user-list">
                {% for user in today_logins %}
                <div class="user-item">
                    {% if user.profile_picture %}
                    <img src="{{ user.profile_picture }}" alt="{{ user.username }}" class="user-avatar-small">
                    {% else %}
                    <div class="user-avatar-placeholder">{{ user.username[0]|upper }}</div>
                    {% endif %}
                    <div class="user-info">
                        <div class="user-name-row">
                            <span class="user-name">{{ user.username }}</span>
                            {% if user.google_id %}
                            <span class="user-badge badge-google">Google</span>
                            {% else %}
                            <span class="user-badge badge-anon">Anonymous</span>
                            {% endif %}
                        </div>
                        {% if user.email %}
                        <span class="user-email">{{ user.email }}</span>
                        {% endif %}
                        {% if user.created_at %}
                        <span class="user-joined">Joined {{ user.created_at|string|truncate(10, True, '') }}</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="no-data">No logged-in users today</p>
            {% endif %}
        </div>
    </div>
</div>

<style>
.admin-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

.admin-header {
    margin-bottom: 2rem;
}

.admin-header h1 {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.admin-subtitle {
    color: var(--text-secondary);
}

.stats-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-box {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem;
    text-align: center;
}

.stat-value {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 2rem;
    font-weight: 700;
    color: var(--accent-primary);
}

.stat-label {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-top: 0.25rem;
}

.admin-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 1.5rem;
}

.admin-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 1.5rem;
}

.admin-card h2 {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 1.1rem;
    margin-bottom: 1rem;
}

.admin-table {
    width: 100%;
    border-collapse: collapse;
}

.admin-table th,
.admin-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--border);
}

.admin-table th {
    font-weight: 600;
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.admin-table td {
    font-size: 0.9rem;
}

.user-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.user-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border);
}

.user-item:last-child {
    border-bottom: none;
}

.user-avatar-small {
    width: 32px;
    height: 32px;
    border-radius: 50%;
}

.user-info {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
    flex: 1;
    min-width: 0;
}

.user-name-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.user-name {
    font-weight: 500;
}

.user-badge {
    font-size: 0.65rem;
    font-weight: 600;
    padding: 0.1rem 0.4rem;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    white-space: nowrap;
}

.badge-google {
    background: rgba(66, 133, 244, 0.15);
    color: #4285f4;
}

.badge-anon {
    background: rgba(255, 167, 38, 0.15);
    color: #ffa726;
}

.user-avatar-placeholder {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--accent-primary);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.85rem;
    flex-shrink: 0;
}

.user-email {
    font-size: 0.8rem;
    color: var(--text-muted);
}

.user-joined {
    font-size: 0.75rem;
    color: var(--text-muted);
    opacity: 0.7;
}

.no-data {
    color: var(--text-muted);
    font-style: italic;
}

.flush-btn {
    padding: 0.6rem 1.2rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    transition: opacity 0.2s;
}

.flush-btn:hover {
    opacity: 0.85;
}

.flush-easy {
    background: #3b82f6;
    color: white;
}

.flush-hard {
    background: #ef4444;
    color: white;
}

.flush-all {
    background: #8b5cf6;
    color: white;
}

.preview-date-input {
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--bg-card);
    color: var(--text-primary);
    font-size: 0.9rem;
}

.preview-section {
    margin-bottom: 1.5rem;
}

.preview-section h3 {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 1rem;
    margin-bottom: 0.75rem;
}

.preview-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
}

.preview-table th,
.preview-table td {
    padding: 0.6rem 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--border);
}

.preview-table th {
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.8rem;
}

.preview-cat-badge {
    display: inline-block;
    padding: 0.15rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    color: #fff;
}

@media (max-width: 600px) {
    .admin-container {
        padding: 1rem;
    }

    .stats-overview {
        grid-template-columns: repeat(2, 1fr);
    }

    .admin-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Set default preview date to tomorrow
(function() {
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('preview-date').value = tomorrow.toISOString().split('T')[0];
})();

async function previewQuestions() {
    const dateInput = document.getElementById('preview-date').value;
    const resultEl = document.getElementById('preview-result');
    const dateLabel = document.getElementById('preview-date-label');
    const sectionsEl = document.getElementById('preview-sections');

    resultEl.style.display = 'block';
    sectionsEl.innerHTML = '<p style="color: var(--text-secondary);">Loading...</p>';
    dateLabel.textContent = '';

    try {
        const body = dateInput ? { date: dateInput } : {};
        const res = await fetch('/admin/preview-questions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!data.success) {
            sectionsEl.innerHTML = `<p style="color: #ef4444;">Error: ${data.error || 'Unknown error'}</p>`;
            return;
        }

        dateLabel.textContent = `Questions for ${data.date}`;
        let html = '';

        for (const [label, questions] of [['Normal', data.questions.normal], ['Expert', data.questions.expert]]) {
            html += `<div class="preview-section"><h3>${label} (${questions.length} questions)</h3>`;
            html += `<table class="preview-table"><thead><tr><th>#</th><th>Category</th><th>Question</th><th>Answer</th><th>Options</th></tr></thead><tbody>`;
            questions.forEach((q, i) => {
                const options = (q.options || []).join(', ');
                html += `<tr>
                    <td>${i + 1}</td>
                    <td><span class="preview-cat-badge" style="background:${q.color}">${q.category_name}</span></td>
                    <td>${q.q}</td>
                    <td><strong>${q.answer}</strong></td>
                    <td style="font-size:0.8rem;color:var(--text-secondary)">${options}</td>
                </tr>`;
            });
            html += '</tbody></table></div>';
        }

        sectionsEl.innerHTML = html;
    } catch (e) {
        sectionsEl.innerHTML = `<p style="color: #ef4444;">Request failed: ${e.message}</p>`;
    }
}

async function flushQuestions(difficulty) {
    const resultEl = document.getElementById('flush-result');
    resultEl.style.display = 'block';
    resultEl.textContent = 'Flushing...';
    resultEl.style.color = 'var(--text-secondary)';

    try {
        const res = await fetch('/admin/flush-questions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ difficulty })
        });
        const data = await res.json();
        if (data.success) {
            resultEl.style.color = '#22c55e';
            resultEl.textContent = `Flushed ${data.questions_flushed} question set(s) and ${data.results_cleared} game result(s) for ${difficulty} on ${data.date}. All users can replay and will get fresh questions.`;
        } else {
            resultEl.style.color = '#ef4444';
            resultEl.textContent = 'Error: ' + (data.error || 'Unknown error');
        }
    } catch (e) {
        resultEl.style.color = '#ef4444';
        resultEl.textContent = 'Request failed: ' + e.message;
    }
}
</script>
{% endblock %}
