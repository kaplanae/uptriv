{% extends 'base.html' %}

{% block title %}History - UpTriv{% endblock %}

{% block content %}
<div class="history-container">
    <div class="history-header">
        <h1>Your Game History</h1>
        <p class="history-subtitle">Review your past games and share your results</p>
    </div>

    <!-- Loading state -->
    <div id="loading-state" class="loading-state">
        <div class="spinner"></div>
        <p>Loading history...</p>
    </div>

    <!-- No data state -->
    <div id="no-data-state" class="no-data-state" style="display: none;">
        <div class="no-data-icon">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 6v6l4 2"/>
            </svg>
        </div>
        <h2>No Games Yet</h2>
        <p>Play your first game to start building your history!</p>
        <a href="{{ url_for('play') }}" class="btn btn-primary">Play Now</a>
    </div>

    <!-- History content -->
    <div id="history-content" style="display: none;">
        <div class="history-list" id="history-list">
            <!-- Games will be inserted here -->
        </div>
    </div>
</div>

<!-- Share toast notification -->
<div id="share-toast" class="share-toast">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="20 6 9 17 4 12"/>
    </svg>
    <span>Copied to clipboard!</span>
</div>
{% endblock %}

{% block scripts %}
<script>
const CATEGORIES = {{ categories | tojson }};

const CAT_EMOJIS = {
    'news': 'üåç',
    'history': 'üìú',
    'science': 'üî¨',
    'entertainment': 'üé¨',
    'sports': 'üèÜ',
    'geography': 'üó∫Ô∏è'
};

async function loadHistory() {
    document.getElementById('loading-state').style.display = 'flex';
    document.getElementById('no-data-state').style.display = 'none';
    document.getElementById('history-content').style.display = 'none';

    const username = localStorage.getItem('uptriv_username');
    if (!username) {
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('no-data-state').style.display = 'flex';
        return;
    }

    try {
        const response = await fetch(`/api/get-history?username=${encodeURIComponent(username)}`);
        const data = await response.json();

        document.getElementById('loading-state').style.display = 'none';

        if (!data.games || data.games.length === 0) {
            document.getElementById('no-data-state').style.display = 'flex';
            return;
        }

        document.getElementById('history-content').style.display = 'block';
        renderHistory(data.games);
    } catch (err) {
        console.error(err);
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('no-data-state').style.display = 'flex';
    }
}

function renderHistory(games) {
    const historyList = document.getElementById('history-list');
    historyList.innerHTML = '';

    games.forEach((game, index) => {
        const gameCard = document.createElement('div');
        gameCard.className = 'game-card';
        gameCard.style.animationDelay = `${index * 0.05}s`;

        // Format date (use UTC to prevent timezone shift)
        const dateObj = new Date(game.date + 'T00:00:00');
        const formattedDate = dateObj.toLocaleDateString('en-US', {
            weekday: 'long',
            month: 'long',
            day: 'numeric',
            year: 'numeric'
        });

        // Build emoji row for preview with colored borders
        const emojiPreview = game.questions.map(r => {
            const emoji = CAT_EMOJIS[r.category] || '‚ùì';
            const statusClass = r.correct ? 'correct' : 'incorrect';
            return `<span class="preview-emoji ${statusClass}">${emoji}</span>`;
        }).join('');

        const difficulty = game.difficulty || 'easy';
        const difficultyLabel = difficulty === 'hard' ? 'üî• Hard' : 'üéØ Easy';
        const difficultyClass = difficulty === 'hard' ? 'hard' : 'easy';

        gameCard.innerHTML = `
            <div class="game-card-header" onclick="toggleGame(this)">
                <div class="game-date-score">
                    <span class="difficulty-badge ${difficultyClass}">${difficultyLabel}</span>
                    <span class="game-date">${formattedDate}</span>
                    <span class="game-score">${game.score}/${game.total}</span>
                </div>
                <div class="game-preview">
                    <div class="emoji-preview">${emojiPreview}</div>
                    <button class="share-btn" onclick="shareGame(event, '${game.date}', '${difficulty}')">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="18" cy="5" r="3"/>
                            <circle cx="6" cy="12" r="3"/>
                            <circle cx="18" cy="19" r="3"/>
                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                        </svg>
                    </button>
                    <svg class="expand-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
            </div>
            <div class="game-card-details">
                ${game.questions.map((r, i) => `
                    <div class="result-row ${r.correct ? 'correct' : 'incorrect'}">
                        <div class="result-category">
                            <span class="cat-emoji-box ${r.correct ? 'correct' : 'incorrect'}">${CAT_EMOJIS[r.category] || '‚ùì'}</span>
                            <span class="cat-name" style="color: ${CATEGORIES[r.category]?.color || '#fff'}">${r.category_name}</span>
                        </div>
                        <div class="result-question">
                            <p class="question-text">${r.question}</p>
                            <div class="answers">
                                <div class="correct-answer">
                                    <span class="answer-label">Correct:</span>
                                    <span class="answer-value">${r.correct_answer}</span>
                                </div>
                                ${!r.correct ? `
                                <div class="user-answer">
                                    <span class="answer-label">Your answer:</span>
                                    <span class="answer-value">${r.user_answer || 'No answer (timed out)'}</span>
                                </div>
                                ` : ''}
                            </div>
                            <div class="question-stat">${r.percent_correct}% of players got this right</div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;

        historyList.appendChild(gameCard);
    });
}

function toggleGame(header) {
    const card = header.closest('.game-card');
    card.classList.toggle('expanded');
}

async function shareGame(event, date) {
    event.stopPropagation();

    const username = localStorage.getItem('uptriv_username');
    if (!username) return;

    try {
        const response = await fetch(`/api/get-share-text?username=${encodeURIComponent(username)}&date=${date}`);
        const data = await response.json();

        if (data.share_text) {
            await navigator.clipboard.writeText(data.share_text);
            showToast();
        }
    } catch (err) {
        console.error('Error sharing:', err);
    }
}

function showToast() {
    const toast = document.getElementById('share-toast');
    toast.classList.add('show');
    setTimeout(() => {
        toast.classList.remove('show');
    }, 2000);
}

// Initial load
loadHistory();
</script>
{% endblock %}
