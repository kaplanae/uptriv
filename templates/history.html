{% extends 'base.html' %}

{% block title %}History - UpTriv{% endblock %}

{% block content %}
<div class="history-container">
    <div class="history-header">
        <h1>Your Game History</h1>
        <p class="history-subtitle">Review your past games and share your results</p>
    </div>

    <!-- Loading state -->
    <div id="loading-state" class="loading-state">
        <div class="spinner"></div>
        <p>Loading history...</p>
    </div>

    <!-- No data state -->
    <div id="no-data-state" class="no-data-state" style="display: none;">
        <div class="no-data-icon">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 6v6l4 2"/>
            </svg>
        </div>
        <h2>No Games Yet</h2>
        <p>Play your first game to start building your history!</p>
        <a href="{{ url_for('play') }}" class="btn btn-primary">Play Now</a>
    </div>

    <!-- Overall Stats Section -->
    <div id="stats-section" class="stats-section" style="display: none;">
        <div class="stats-card">
            <div class="stats-header">
                <h2>Your Performance</h2>
                <span class="games-count" id="games-played">0 games</span>
            </div>

            <!-- Overall Score Bar -->
            <div class="overall-stat-row">
                <div class="stat-label-row">
                    <span class="stat-label">Overall</span>
                    <span class="stat-pct" id="overall-pct">0%</span>
                </div>
                <div class="stat-bar-track">
                    <div class="stat-bar-fill overall-fill" id="overall-bar"></div>
                </div>
            </div>

            <!-- Category Bars -->
            <div class="category-stats" id="category-stats">
                <!-- Category bars will be inserted here -->
            </div>
        </div>

        <!-- Subcategory Breakdown -->
        <div class="subcategory-card" id="subcategory-section" style="display: none;">
            <div class="stats-header">
                <h2>Topic Breakdown</h2>
            </div>
            <div id="subcategory-stats">
                <!-- Subcategory bars will be inserted here -->
            </div>
        </div>
    </div>

    <!-- History content -->
    <div id="history-content" style="display: none;">
        <div class="history-list" id="history-list">
            <!-- Games will be inserted here -->
        </div>
    </div>
</div>

<!-- Share toast notification -->
<div id="share-toast" class="share-toast">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="20 6 9 17 4 12"/>
    </svg>
    <span>Copied to clipboard!</span>
</div>
{% endblock %}

{% block scripts %}
<script>
const CATEGORIES = {{ categories | tojson }};

const CAT_EMOJIS = {
    'news': 'üåç',
    'history': 'üìú',
    'science': 'üî¨',
    'entertainment': 'üé¨',
    'sports': 'üèÜ',
    'geography': 'üó∫Ô∏è'
};

async function loadHistory() {
    document.getElementById('loading-state').style.display = 'flex';
    document.getElementById('no-data-state').style.display = 'none';
    document.getElementById('history-content').style.display = 'none';
    document.getElementById('stats-section').style.display = 'none';

    const username = localStorage.getItem('uptriv_username');
    const anonymousId = localStorage.getItem('uptriv_anonymous_id');

    if (!username && !anonymousId) {
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('no-data-state').style.display = 'flex';
        return;
    }

    try {
        // Fetch history and overall stats
        const historyParams = new URLSearchParams();
        if (username) historyParams.set('username', username);
        if (anonymousId) historyParams.set('anonymous_id', anonymousId);

        const statsUrl = username ? `/api/get-stats?username=${encodeURIComponent(username)}` : '/api/get-stats';

        const [historyRes, statsRes] = await Promise.all([
            fetch(`/api/get-history?${historyParams.toString()}`),
            fetch(statsUrl)
        ]);

        const historyData = await historyRes.json();
        const statsData = await statsRes.json();

        console.log('History API response:', historyData);
        console.log('Stats API response:', statsData);

        document.getElementById('loading-state').style.display = 'none';

        let hasContent = false;

        // Show overall stats if user has played games
        if (statsData.total_games > 0) {
            document.getElementById('stats-section').style.display = 'block';
            renderOverallStats(statsData);
            hasContent = true;
        }

        // Show regular game history
        if (historyData.games && historyData.games.length > 0) {
            document.getElementById('history-content').style.display = 'block';
            renderHistory(historyData.games);
            hasContent = true;
        }

        if (!hasContent) {
            document.getElementById('no-data-state').style.display = 'flex';
        }
    } catch (err) {
        console.error(err);
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('no-data-state').style.display = 'flex';
    }
}

function renderHistory(games) {
    const historyList = document.getElementById('history-list');
    historyList.innerHTML = '';

    // Group games by date
    const gamesByDate = {};
    games.forEach(game => {
        if (!gamesByDate[game.date]) {
            gamesByDate[game.date] = [];
        }
        gamesByDate[game.date].push(game);
    });

    // Sort dates descending
    const sortedDates = Object.keys(gamesByDate).sort((a, b) => b.localeCompare(a));

    sortedDates.forEach((date, dateIndex) => {
        const dayGames = gamesByDate[date];

        // Format date
        const dateObj = new Date(date + 'T00:00:00');
        const formattedDate = dateObj.toLocaleDateString('en-US', {
            weekday: 'long',
            month: 'long',
            day: 'numeric',
            year: 'numeric'
        });

        // Create date group container
        const dateGroup = document.createElement('div');
        dateGroup.className = 'date-group';
        dateGroup.style.animationDelay = `${dateIndex * 0.05}s`;

        // Date header
        const dateHeader = document.createElement('div');
        dateHeader.className = 'date-header';
        dateHeader.innerHTML = `<h3>${formattedDate}</h3>`;
        dateGroup.appendChild(dateHeader);

        // Sort games: hard first, then easy
        dayGames.sort((a, b) => (b.difficulty || 'easy').localeCompare(a.difficulty || 'easy'));

        // Render each difficulty as a sub-row
        dayGames.forEach((game, gameIndex) => {
            const difficulty = game.difficulty || 'easy';
            const difficultyLabel = difficulty === 'hard' ? 'üî• Hard' : 'üéØ Easy';
            const difficultyClass = difficulty === 'hard' ? 'hard' : 'easy';

            // Build emoji row for preview
            const emojiPreview = game.questions.map(r => {
                const emoji = CAT_EMOJIS[r.category] || '‚ùì';
                const statusClass = r.correct ? 'correct' : 'incorrect';
                return `<span class="preview-emoji ${statusClass}">${emoji}</span>`;
            }).join('');

            const gameRow = document.createElement('div');
            gameRow.className = 'game-row';

            gameRow.innerHTML = `
                <div class="game-row-header" onclick="toggleGameRow(this)">
                    <div class="difficulty-label ${difficultyClass}">${difficultyLabel}</div>
                    <div class="game-row-content">
                        <div class="emoji-preview">${emojiPreview}</div>
                        <span class="game-score">${game.score}/${game.total}</span>
                    </div>
                    <div class="game-row-actions">
                        <button class="share-btn" onclick="shareGame(event, '${game.date}', '${difficulty}')">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="18" cy="5" r="3"/>
                                <circle cx="6" cy="12" r="3"/>
                                <circle cx="18" cy="19" r="3"/>
                                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                            </svg>
                        </button>
                        <svg class="expand-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </div>
                </div>
                <div class="game-row-details">
                    ${game.questions.map((r, i) => `
                        <div class="result-row ${r.correct ? 'correct' : 'incorrect'}">
                            <div class="result-category">
                                <span class="cat-emoji-box ${r.correct ? 'correct' : 'incorrect'}">${CAT_EMOJIS[r.category] || '‚ùì'}</span>
                                <span class="cat-name" style="color: ${CATEGORIES[r.category]?.color || '#fff'}">${r.category_name}</span>
                            </div>
                            <div class="result-question">
                                <p class="question-text">${r.question}</p>
                                <div class="answers">
                                    <div class="correct-answer">
                                        <span class="answer-label">Correct:</span>
                                        <span class="answer-value">${r.correct_answer}</span>
                                    </div>
                                    ${!r.correct ? `
                                    <div class="user-answer">
                                        <span class="answer-label">Your answer:</span>
                                        <span class="answer-value">${r.user_answer || 'No answer (timed out)'}</span>
                                    </div>
                                    ` : ''}
                                </div>
                                <div class="question-stat">${r.percent_correct}% of players got this right</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            dateGroup.appendChild(gameRow);
        });

        historyList.appendChild(dateGroup);
    });
}

function renderOverallStats(data) {
    // Update overall score
    const pct = data.overall_percentage;
    document.getElementById('overall-pct').textContent = `${pct}%`;
    document.getElementById('games-played').textContent = `${data.total_games} game${data.total_games !== 1 ? 's' : ''}`;

    // Update overall bar
    const overallBar = document.getElementById('overall-bar');
    overallBar.style.width = `${pct}%`;

    // Color based on percentage
    let color;
    if (pct >= 80) color = '#22c55e';
    else if (pct >= 60) color = '#84cc16';
    else if (pct >= 40) color = '#eab308';
    else color = '#ef4444';
    overallBar.style.background = color;

    // Render category bars
    const container = document.getElementById('category-stats');
    container.innerHTML = '';

    for (const [cat, catMeta] of Object.entries(CATEGORIES)) {
        const stats = data.categories[cat] || { percentage: 0, correct: 0, total: 0 };
        const bar = document.createElement('div');
        bar.className = 'cat-stat-row';
        bar.innerHTML = `
            <div class="stat-label-row">
                <span class="cat-stat-label">
                    <span class="cat-emoji">${CAT_EMOJIS[cat] || '‚ùì'}</span>
                    <span style="color: ${catMeta.color}">${catMeta.name}</span>
                </span>
                <span class="stat-pct">${stats.percentage}%</span>
            </div>
            <div class="stat-bar-track">
                <div class="stat-bar-fill" style="width: ${stats.percentage}%; background: ${catMeta.color}"></div>
            </div>
        `;
        container.appendChild(bar);
    }

    // Render subcategory breakdown
    renderSubcategoryStats(data);
}

function renderSubcategoryStats(data) {
    const subcats = data.subcategories || {};
    const subEntries = Object.entries(subcats).filter(([_, s]) => s.total >= 2);

    if (subEntries.length === 0) {
        document.getElementById('subcategory-section').style.display = 'none';
        return;
    }

    document.getElementById('subcategory-section').style.display = 'block';

    // Sort by percentage descending
    subEntries.sort((a, b) => b[1].percentage - a[1].percentage);

    const container = document.getElementById('subcategory-stats');
    container.innerHTML = '';

    for (const [subName, stats] of subEntries) {
        const catMeta = CATEGORIES[stats.category] || {};
        const pctClass = stats.percentage >= 70 ? 'high' : stats.percentage >= 50 ? 'medium' : 'low';

        const row = document.createElement('div');
        row.className = 'subcat-stat-row';
        row.innerHTML = `
            <div class="subcat-label-row">
                <span class="subcat-name">${subName.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}</span>
                <span class="subcat-detail">${stats.correct}/${stats.total}</span>
                <span class="subcat-pct ${pctClass}">${stats.percentage}%</span>
            </div>
            <div class="stat-bar-track">
                <div class="stat-bar-fill" style="width: ${stats.percentage}%; background: ${catMeta.color || '#667eea'}"></div>
            </div>
        `;
        container.appendChild(row);
    }
}

function toggleGameRow(header) {
    const row = header.closest('.game-row');
    row.classList.toggle('expanded');
}

function toggleGame(header) {
    const card = header.closest('.game-card');
    card.classList.toggle('expanded');
}

async function shareGame(event, date) {
    event.stopPropagation();

    const username = localStorage.getItem('uptriv_username');
    if (!username) return;

    try {
        const response = await fetch(`/api/get-share-text?username=${encodeURIComponent(username)}&date=${date}`);
        const data = await response.json();

        if (data.share_text) {
            await navigator.clipboard.writeText(data.share_text);
            showToast();
        }
    } catch (err) {
        console.error('Error sharing:', err);
    }
}

function showToast() {
    const toast = document.getElementById('share-toast');
    toast.classList.add('show');
    setTimeout(() => {
        toast.classList.remove('show');
    }, 2000);
}

// Initial load
loadHistory();
</script>
{% endblock %}
