{% extends 'base.html' %}

{% block title %}History - UpTriv{% endblock %}

{% block content %}
<div class="history-container">
    <div class="history-header">
        <h1>Your Game History</h1>
        <p class="history-subtitle">Review your past games and share your results</p>
    </div>

    <!-- Loading state -->
    <div id="loading-state" class="loading-state">
        <div class="spinner"></div>
        <p>Loading history...</p>
    </div>

    <!-- No data state -->
    <div id="no-data-state" class="no-data-state" style="display: none;">
        <div class="no-data-icon">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 6v6l4 2"/>
            </svg>
        </div>
        <h2>No Games Yet</h2>
        <p>Play your first game to start building your history!</p>
        <a href="{{ url_for('play') }}" class="btn btn-primary">Play Now</a>
    </div>

    <!-- Profile Quiz Section -->
    <div id="profile-quiz-section" class="profile-quiz-section" style="display: none;">
        <div class="date-group">
            <div class="date-header">
                <h3>üìä Profile Quiz</h3>
            </div>
            <div class="game-row">
                <div class="game-row-header" onclick="toggleGameRow(this)">
                    <div class="difficulty-label" style="background: linear-gradient(135deg, #667eea, #764ba2);">üß† Knowledge Profile</div>
                    <div class="game-row-content">
                        <span id="profile-quiz-progress"></span>
                        <span class="game-score" id="profile-quiz-score"></span>
                    </div>
                    <div class="game-row-actions">
                        <a href="{{ url_for('onboarding') }}" class="share-btn" style="text-decoration: none;" title="View Details">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                <polyline points="15 3 21 3 21 9"/>
                                <line x1="10" y1="14" x2="21" y2="3"/>
                            </svg>
                        </a>
                        <svg class="expand-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </div>
                </div>
                <div class="game-row-details" id="profile-quiz-breakdown">
                    <!-- Category breakdown will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- History content -->
    <div id="history-content" style="display: none;">
        <div class="history-list" id="history-list">
            <!-- Games will be inserted here -->
        </div>
    </div>
</div>

<!-- Share toast notification -->
<div id="share-toast" class="share-toast">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="20 6 9 17 4 12"/>
    </svg>
    <span>Copied to clipboard!</span>
</div>
{% endblock %}

{% block scripts %}
<script>
const CATEGORIES = {{ categories | tojson }};

const CAT_EMOJIS = {
    'news': 'üåç',
    'history': 'üìú',
    'science': 'üî¨',
    'entertainment': 'üé¨',
    'sports': 'üèÜ',
    'geography': 'üó∫Ô∏è'
};

async function loadHistory() {
    document.getElementById('loading-state').style.display = 'flex';
    document.getElementById('no-data-state').style.display = 'none';
    document.getElementById('history-content').style.display = 'none';
    document.getElementById('profile-quiz-section').style.display = 'none';

    const username = localStorage.getItem('uptriv_username');
    const anonymousId = localStorage.getItem('uptriv_anonymous_id');

    if (!username && !anonymousId) {
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('no-data-state').style.display = 'flex';
        return;
    }

    try {
        // Fetch both regular history and profile quiz status
        const [historyRes, quizRes] = await Promise.all([
            fetch(`/api/get-history?username=${encodeURIComponent(username || '')}`),
            fetch(`/api/onboarding-results?anonymous_id=${encodeURIComponent(anonymousId || '')}`)
        ]);

        const historyData = await historyRes.json();
        const quizData = await quizRes.json();

        document.getElementById('loading-state').style.display = 'none';

        let hasContent = false;

        // Show profile quiz section if user has completed any questions
        if (quizData.success && quizData.overall) {
            document.getElementById('profile-quiz-section').style.display = 'block';
            document.getElementById('profile-quiz-progress').textContent = `${quizData.overall.completed}/50 questions`;
            document.getElementById('profile-quiz-score').textContent = `${quizData.overall.percentage}%`;

            // Build category breakdown
            let breakdownHtml = '';
            for (const [cat, stats] of Object.entries(quizData.categories || {})) {
                const catInfo = CATEGORIES[cat] || {};
                const emoji = CAT_EMOJIS[cat] || '‚ùì';
                breakdownHtml += `
                    <div class="result-row ${stats.percentage >= 50 ? 'correct' : 'incorrect'}">
                        <div class="result-category">
                            <span class="cat-emoji-box ${stats.percentage >= 50 ? 'correct' : 'incorrect'}">${emoji}</span>
                            <span class="cat-name" style="color: ${catInfo.color || '#fff'}">${catInfo.name || cat}</span>
                        </div>
                        <div class="result-question">
                            <div class="answers">
                                <span class="answer-value">${stats.correct}/${stats.total} correct (${stats.percentage}%)</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            document.getElementById('profile-quiz-breakdown').innerHTML = breakdownHtml;
            hasContent = true;
        }

        // Show regular game history
        if (historyData.games && historyData.games.length > 0) {
            document.getElementById('history-content').style.display = 'block';
            renderHistory(historyData.games);
            hasContent = true;
        }

        if (!hasContent) {
            document.getElementById('no-data-state').style.display = 'flex';
        }
    } catch (err) {
        console.error(err);
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('no-data-state').style.display = 'flex';
    }
}

function renderHistory(games) {
    const historyList = document.getElementById('history-list');
    historyList.innerHTML = '';

    // Group games by date
    const gamesByDate = {};
    games.forEach(game => {
        if (!gamesByDate[game.date]) {
            gamesByDate[game.date] = [];
        }
        gamesByDate[game.date].push(game);
    });

    // Sort dates descending
    const sortedDates = Object.keys(gamesByDate).sort((a, b) => b.localeCompare(a));

    sortedDates.forEach((date, dateIndex) => {
        const dayGames = gamesByDate[date];

        // Format date
        const dateObj = new Date(date + 'T00:00:00');
        const formattedDate = dateObj.toLocaleDateString('en-US', {
            weekday: 'long',
            month: 'long',
            day: 'numeric',
            year: 'numeric'
        });

        // Create date group container
        const dateGroup = document.createElement('div');
        dateGroup.className = 'date-group';
        dateGroup.style.animationDelay = `${dateIndex * 0.05}s`;

        // Date header
        const dateHeader = document.createElement('div');
        dateHeader.className = 'date-header';
        dateHeader.innerHTML = `<h3>${formattedDate}</h3>`;
        dateGroup.appendChild(dateHeader);

        // Sort games: hard first, then easy
        dayGames.sort((a, b) => (b.difficulty || 'easy').localeCompare(a.difficulty || 'easy'));

        // Render each difficulty as a sub-row
        dayGames.forEach((game, gameIndex) => {
            const difficulty = game.difficulty || 'easy';
            const difficultyLabel = difficulty === 'hard' ? 'üî• Hard' : 'üéØ Easy';
            const difficultyClass = difficulty === 'hard' ? 'hard' : 'easy';

            // Build emoji row for preview
            const emojiPreview = game.questions.map(r => {
                const emoji = CAT_EMOJIS[r.category] || '‚ùì';
                const statusClass = r.correct ? 'correct' : 'incorrect';
                return `<span class="preview-emoji ${statusClass}">${emoji}</span>`;
            }).join('');

            const gameRow = document.createElement('div');
            gameRow.className = 'game-row';

            gameRow.innerHTML = `
                <div class="game-row-header" onclick="toggleGameRow(this)">
                    <div class="difficulty-label ${difficultyClass}">${difficultyLabel}</div>
                    <div class="game-row-content">
                        <div class="emoji-preview">${emojiPreview}</div>
                        <span class="game-score">${game.score}/${game.total}</span>
                    </div>
                    <div class="game-row-actions">
                        <button class="share-btn" onclick="shareGame(event, '${game.date}', '${difficulty}')">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="18" cy="5" r="3"/>
                                <circle cx="6" cy="12" r="3"/>
                                <circle cx="18" cy="19" r="3"/>
                                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                            </svg>
                        </button>
                        <svg class="expand-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </div>
                </div>
                <div class="game-row-details">
                    ${game.questions.map((r, i) => `
                        <div class="result-row ${r.correct ? 'correct' : 'incorrect'}">
                            <div class="result-category">
                                <span class="cat-emoji-box ${r.correct ? 'correct' : 'incorrect'}">${CAT_EMOJIS[r.category] || '‚ùì'}</span>
                                <span class="cat-name" style="color: ${CATEGORIES[r.category]?.color || '#fff'}">${r.category_name}</span>
                            </div>
                            <div class="result-question">
                                <p class="question-text">${r.question}</p>
                                <div class="answers">
                                    <div class="correct-answer">
                                        <span class="answer-label">Correct:</span>
                                        <span class="answer-value">${r.correct_answer}</span>
                                    </div>
                                    ${!r.correct ? `
                                    <div class="user-answer">
                                        <span class="answer-label">Your answer:</span>
                                        <span class="answer-value">${r.user_answer || 'No answer (timed out)'}</span>
                                    </div>
                                    ` : ''}
                                </div>
                                <div class="question-stat">${r.percent_correct}% of players got this right</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            dateGroup.appendChild(gameRow);
        });

        historyList.appendChild(dateGroup);
    });
}

function toggleGameRow(header) {
    const row = header.closest('.game-row');
    row.classList.toggle('expanded');
}

function toggleGame(header) {
    const card = header.closest('.game-card');
    card.classList.toggle('expanded');
}

async function shareGame(event, date) {
    event.stopPropagation();

    const username = localStorage.getItem('uptriv_username');
    if (!username) return;

    try {
        const response = await fetch(`/api/get-share-text?username=${encodeURIComponent(username)}&date=${date}`);
        const data = await response.json();

        if (data.share_text) {
            await navigator.clipboard.writeText(data.share_text);
            showToast();
        }
    } catch (err) {
        console.error('Error sharing:', err);
    }
}

function showToast() {
    const toast = document.getElementById('share-toast');
    toast.classList.add('show');
    setTimeout(() => {
        toast.classList.remove('show');
    }, 2000);
}

// Initial load
loadHistory();
</script>
{% endblock %}
