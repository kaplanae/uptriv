{% extends 'base.html' %}

{% block title %}{% if view_username %}{{ view_username }}'s Profile{% else %}Profile{% endif %} - UpTriv{% endblock %}

{% block content %}
<div class="history-container">
    <div class="history-header">
        {% if view_username %}
        <h1>{{ view_username }}'s Profile</h1>
        <p class="history-subtitle">Viewing another player's performance and history</p>
        {% else %}
        <h1>Your Profile</h1>
        <p class="history-subtitle">Performance, game history, and personalized recommendations</p>
        {% endif %}
    </div>

    <!-- Loading state -->
    <div id="loading-state" class="loading-state">
        <div class="spinner"></div>
        <p>Loading history...</p>
    </div>

    <!-- No data state -->
    <div id="no-data-state" class="no-data-state" style="display: none;">
        <div class="no-data-icon">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 6v6l4 2"/>
            </svg>
        </div>
        <h2>No Games Yet</h2>
        <p>Play your first game to start building your history!</p>
        <a href="{{ url_for('play') }}" class="btn btn-primary">Play Now</a>
    </div>

    <!-- Main Content Grid -->
    <div id="main-content" class="history-grid" style="display: none;">
        <!-- Left Column: Performance Stats -->
        <div class="stats-column">
            <!-- Overall Stats Section -->
            <div id="stats-section" class="stats-card">
                <div class="stats-header">
                    <h2>Your Performance</h2>
                    <span class="games-count" id="games-played">0 games</span>
                </div>

                <!-- Overall Score Bar -->
                <div class="overall-stat-row">
                    <div class="stat-label-row">
                        <span class="stat-label">Overall</span>
                        <span class="stat-pct" id="overall-pct">0%</span>
                    </div>
                    <div class="bar-chart-track">
                        <div class="bar-chart-fill" id="overall-bar"></div>
                    </div>
                </div>

                <!-- Category Bars -->
                <div class="category-stats" id="category-stats">
                    <!-- Category bars will be inserted here -->
                </div>
            </div>

            <!-- Subcategory Breakdown -->
            <div class="stats-card" id="subcategory-section" style="display: none;">
                <div class="stats-header">
                    <h2>Topic Breakdown</h2>
                </div>
                <div id="subcategory-stats">
                    <!-- Subcategory bars will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Right Column: Game History -->
        <div class="history-column">
            <div class="stats-card">
                <div class="stats-header">
                    <h2>Daily Games</h2>
                </div>
                <div class="history-list" id="history-list">
                    <!-- Games will be inserted here -->
                </div>
            </div>

            <!-- Profile Builder Results -->
            <div class="stats-card" id="profile-quiz-section" style="display: none;">
                <div class="stats-header">
                    <h2>Profile Builder</h2>
                    <span class="quiz-progress" id="quiz-progress">0/50</span>
                </div>
                <div id="profile-quiz-content">
                    <!-- Profile quiz results will be inserted here -->
                </div>
                <div id="profile-quiz-cta" style="display: none; margin-top: 1rem;">
                    <a href="{{ url_for('onboarding') }}" class="btn btn-secondary" style="width: 100%;">Continue Profile Builder</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Player Summary & Recommendations Section -->
    <div id="player-summary-section" class="player-summary-section" style="display: none;">
        <div class="summary-card">
            <div class="summary-header">
                <div class="skill-badge" id="skill-badge">
                    <span class="skill-level" id="skill-level">Trivia Rookie</span>
                </div>
                <div class="summary-stats">
                    <span id="summary-questions">0 questions answered</span>
                    <span id="summary-accuracy">0% accuracy</span>
                </div>
            </div>

            <div class="summary-text" id="summary-text">
                <p id="summary-desc"></p>
                <p id="summary-strength" class="strength-text"></p>
                <p id="summary-weakness" class="weakness-text"></p>
            </div>
        </div>

        <div class="recommendations-section" id="recommendations-section" style="display: none;">
            <h3 class="recommendations-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                </svg>
                Fill Your Knowledge Gaps
            </h3>
            <p class="recommendations-subtitle">Books, videos, podcasts and shows based on your performance</p>
            <div class="recommendations-grid" id="recommendations-grid">
                <!-- Will be populated by JS -->
            </div>
        </div>
    </div>
</div>

<!-- Share toast notification -->
<div id="share-toast" class="share-toast">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="20 6 9 17 4 12"/>
    </svg>
    <span>Copied to clipboard!</span>
</div>
{% endblock %}

{% block scripts %}
<script>
const CATEGORIES = {{ categories | tojson }};

const CAT_EMOJIS = {
    'news': 'üåç',
    'history': 'üìú',
    'science': 'üî¨',
    'entertainment': 'üé¨',
    'sports': 'üèÜ',
    'geography': 'üó∫Ô∏è'
};

// Check if viewing another user's profile
const VIEW_USERNAME = {{ view_username | tojson if view_username else 'null' }};
const IS_VIEWING_OTHER = VIEW_USERNAME !== null;

async function loadHistory() {
    document.getElementById('loading-state').style.display = 'flex';
    document.getElementById('no-data-state').style.display = 'none';
    document.getElementById('main-content').style.display = 'none';

    // Use view_username if viewing another user, otherwise use logged-in user
    const username = IS_VIEWING_OTHER ? VIEW_USERNAME : localStorage.getItem('uptriv_username');
    const anonymousId = IS_VIEWING_OTHER ? null : localStorage.getItem('uptriv_anonymous_id');

    if (!username && !anonymousId) {
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('no-data-state').style.display = 'flex';
        return;
    }

    try {
        // Fetch history and overall stats
        const historyParams = new URLSearchParams();
        if (username) historyParams.set('username', username);
        if (anonymousId) historyParams.set('anonymous_id', anonymousId);

        const statsUrl = username ? `/api/get-stats?username=${encodeURIComponent(username)}` : '/api/get-stats';

        // Build onboarding URL with anonymous_id if needed (only for own profile)
        const onboardingParams = new URLSearchParams();
        if (anonymousId && !IS_VIEWING_OTHER) onboardingParams.set('anonymous_id', anonymousId);

        const [historyRes, statsRes, onboardingRes] = await Promise.all([
            fetch(`/api/get-history?${historyParams.toString()}`),
            fetch(statsUrl),
            IS_VIEWING_OTHER ? Promise.resolve({ json: () => ({ success: false }) }) : fetch(`/api/onboarding-results?${onboardingParams.toString()}`)
        ]);

        const historyData = await historyRes.json();
        const statsData = await statsRes.json();
        const onboardingData = await onboardingRes.json();

        console.log('History API response:', historyData);
        console.log('Stats API response:', statsData);
        console.log('Onboarding API response:', onboardingData);

        document.getElementById('loading-state').style.display = 'none';

        let hasStats = statsData.total_games > 0;
        let hasHistory = historyData.games && historyData.games.length > 0;
        let hasOnboarding = onboardingData.success && onboardingData.overall;

        if (hasStats || hasHistory || hasOnboarding) {
            document.getElementById('main-content').style.display = 'grid';

            if (hasStats) {
                renderOverallStats(statsData);
                renderPlayerSummary(statsData);
            }

            if (hasHistory) {
                renderHistory(historyData.games);
            }

            if (hasOnboarding) {
                renderProfileQuiz(onboardingData);
            }
        } else {
            document.getElementById('no-data-state').style.display = 'flex';
        }
    } catch (err) {
        console.error(err);
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('no-data-state').style.display = 'flex';
    }
}

function renderHistory(games) {
    const historyList = document.getElementById('history-list');
    historyList.innerHTML = '';

    // Group games by date
    const gamesByDate = {};
    games.forEach(game => {
        if (!gamesByDate[game.date]) {
            gamesByDate[game.date] = [];
        }
        gamesByDate[game.date].push(game);
    });

    // Sort dates descending
    const sortedDates = Object.keys(gamesByDate).sort((a, b) => b.localeCompare(a));

    sortedDates.forEach((date, dateIndex) => {
        const dayGames = gamesByDate[date];

        // Format date
        const dateObj = new Date(date + 'T00:00:00');
        const formattedDate = dateObj.toLocaleDateString('en-US', {
            weekday: 'long',
            month: 'long',
            day: 'numeric',
            year: 'numeric'
        });

        // Create date group container
        const dateGroup = document.createElement('div');
        dateGroup.className = 'date-group';
        dateGroup.style.animationDelay = `${dateIndex * 0.05}s`;

        // Date header
        const dateHeader = document.createElement('div');
        dateHeader.className = 'date-header';
        dateHeader.innerHTML = `<h3>${formattedDate}</h3>`;
        dateGroup.appendChild(dateHeader);

        // Sort games: hard first, then easy
        dayGames.sort((a, b) => (b.difficulty || 'easy').localeCompare(a.difficulty || 'easy'));

        // Render each difficulty as a sub-row
        dayGames.forEach((game, gameIndex) => {
            const difficulty = game.difficulty || 'easy';
            const difficultyLabel = difficulty === 'hard' ? 'üî• Expert' : 'üéØ Normal';
            const difficultyClass = difficulty === 'hard' ? 'hard' : 'easy';

            // Build emoji row for preview
            const emojiPreview = game.questions.map(r => {
                const emoji = CAT_EMOJIS[r.category] || '‚ùì';
                const statusClass = r.correct ? 'correct' : 'incorrect';
                return `<span class="preview-emoji ${statusClass}">${emoji}</span>`;
            }).join('');

            const gameRow = document.createElement('div');
            gameRow.className = 'game-row';

            gameRow.innerHTML = `
                <div class="game-row-header" onclick="toggleGameRow(this)">
                    <div class="difficulty-label ${difficultyClass}">${difficultyLabel}</div>
                    <div class="emoji-preview">${emojiPreview}</div>
                    <button class="share-btn" onclick="shareGame(event, '${game.date}', '${difficulty}')" title="Share results">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="18" cy="5" r="3"/>
                            <circle cx="6" cy="12" r="3"/>
                            <circle cx="18" cy="19" r="3"/>
                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                        </svg>
                    </button>
                    <svg class="expand-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
                <div class="game-row-details">
                    ${game.questions.map((r, i) => `
                        <div class="result-row ${r.correct ? 'correct' : 'incorrect'}">
                            <div class="result-category">
                                <span class="cat-emoji-box ${r.correct ? 'correct' : 'incorrect'}">${CAT_EMOJIS[r.category] || '‚ùì'}</span>
                                <span class="cat-name" style="color: ${CATEGORIES[r.category]?.color || '#fff'}">${r.category_name}</span>
                            </div>
                            <div class="result-question">
                                <p class="question-text">${r.question}</p>
                                <div class="answers">
                                    <div class="correct-answer">
                                        <span class="answer-label">Correct:</span>
                                        <span class="answer-value">${r.correct_answer}</span>
                                    </div>
                                    ${!r.correct ? `
                                    <div class="user-answer">
                                        <span class="answer-label">Your answer:</span>
                                        <span class="answer-value">${r.user_answer || 'No answer (timed out)'}</span>
                                    </div>
                                    ` : ''}
                                </div>
                                <div class="question-stat">${r.percent_correct}% of players got this right</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            dateGroup.appendChild(gameRow);
        });

        historyList.appendChild(dateGroup);
    });
}

function diffBreakdownHtml(easyTotal, easyPct, hardTotal, hardPct) {
    const parts = [];
    if (easyTotal > 0) parts.push(`${easyPct}% Normal`);
    if (hardTotal > 0) parts.push(`${hardPct}% Expert`);
    if (parts.length > 1) {
        return `<span class="diff-breakdown">(${parts.join(', ')})</span>`;
    }
    return '';
}

function renderOverallStats(data) {
    // Update overall score
    const pct = data.overall_percentage;
    document.getElementById('overall-pct').textContent = `${pct}%`;
    document.getElementById('games-played').textContent = `${data.total_games} game${data.total_games !== 1 ? 's' : ''}`;

    // Update overall bar
    const overallBar = document.getElementById('overall-bar');
    overallBar.style.width = `${pct}%`;

    // Color based on percentage
    let color;
    if (pct >= 80) color = '#22c55e';
    else if (pct >= 60) color = '#84cc16';
    else if (pct >= 40) color = '#eab308';
    else color = '#ef4444';
    overallBar.style.backgroundColor = color;

    // Show overall difficulty breakdown
    const overallBreakdown = diffBreakdownHtml(
        data.overall_easy_total || 0, data.overall_easy_percentage || 0,
        data.overall_hard_total || 0, data.overall_hard_percentage || 0
    );
    if (overallBreakdown) {
        const overallRow = document.querySelector('.overall-stat-row');
        const existing = overallRow.querySelector('.diff-breakdown');
        if (existing) existing.remove();
        overallRow.insertAdjacentHTML('beforeend', overallBreakdown);
    }

    // Render category bars
    const container = document.getElementById('category-stats');
    container.innerHTML = '';

    for (const [cat, catMeta] of Object.entries(CATEGORIES)) {
        const stats = data.categories[cat] || { percentage: 0, correct: 0, total: 0 };
        const breakdown = diffBreakdownHtml(
            stats.easy_total || 0, stats.easy_percentage || 0,
            stats.hard_total || 0, stats.hard_percentage || 0
        );
        const bar = document.createElement('div');
        bar.className = 'cat-stat-row';
        bar.innerHTML = `
            <div class="stat-label-row">
                <span class="cat-stat-label">
                    <span class="cat-emoji">${CAT_EMOJIS[cat] || '‚ùì'}</span>
                    <span style="color: ${catMeta.color}">${catMeta.name}</span>
                </span>
                <span class="stat-pct">${stats.percentage}% ${breakdown}</span>
            </div>
            <div class="bar-chart-track">
                <div class="bar-chart-fill" style="width: ${stats.percentage}%; background-color: ${catMeta.color};"></div>
            </div>
        `;
        container.appendChild(bar);
    }

    // Render subcategory breakdown
    renderSubcategoryStats(data);
}

function renderSubcategoryStats(data) {
    const subcats = data.subcategories || {};
    const subEntries = Object.entries(subcats).filter(([_, s]) => s.total >= 2);

    if (subEntries.length === 0) {
        document.getElementById('subcategory-section').style.display = 'none';
        return;
    }

    document.getElementById('subcategory-section').style.display = 'block';

    // Sort by percentage descending
    subEntries.sort((a, b) => b[1].percentage - a[1].percentage);

    const container = document.getElementById('subcategory-stats');
    container.innerHTML = '';

    for (const [subName, stats] of subEntries) {
        const catMeta = CATEGORIES[stats.category] || {};
        const pctClass = stats.percentage >= 70 ? 'high' : stats.percentage >= 50 ? 'medium' : 'low';

        const row = document.createElement('div');
        row.className = 'subcat-stat-row';
        row.innerHTML = `
            <div class="subcat-label-row">
                <span class="subcat-name">${subName.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}</span>
                <span class="subcat-detail">${stats.correct}/${stats.total}</span>
                <span class="subcat-pct ${pctClass}">${stats.percentage}%</span>
            </div>
            <div class="bar-chart-track">
                <div class="bar-chart-fill" style="width: ${stats.percentage}%; background-color: ${catMeta.color || '#667eea'};"></div>
            </div>
        `;
        container.appendChild(row);
    }
}

function renderProfileQuiz(data) {
    const section = document.getElementById('profile-quiz-section');
    const content = document.getElementById('profile-quiz-content');
    const progress = document.getElementById('quiz-progress');
    const cta = document.getElementById('profile-quiz-cta');

    section.style.display = 'block';

    const completed = data.overall.completed || 0;
    const total = 50;
    const pct = data.overall.percentage || 0;

    progress.textContent = `${completed}/${total}`;

    // Overall score bar
    let overallColor;
    if (pct >= 80) overallColor = '#22c55e';
    else if (pct >= 60) overallColor = '#84cc16';
    else if (pct >= 40) overallColor = '#eab308';
    else overallColor = '#ef4444';

    let html = `
        <div class="overall-stat-row">
            <div class="stat-label-row">
                <span class="stat-label">Overall Score</span>
                <span class="stat-pct">${pct}%</span>
            </div>
            <div class="bar-chart-track">
                <div class="bar-chart-fill" style="width: ${pct}%; background-color: ${overallColor};"></div>
            </div>
        </div>
        <div class="category-stats" style="margin-top: 1rem;">
    `;

    // Category breakdown
    for (const [cat, catMeta] of Object.entries(CATEGORIES)) {
        const stats = data.categories[cat] || { percentage: 0, correct: 0, total: 0 };
        if (stats.total > 0) {
            html += `
                <div class="cat-stat-row">
                    <div class="stat-label-row">
                        <span class="cat-stat-label">
                            <span class="cat-emoji">${CAT_EMOJIS[cat] || '‚ùì'}</span>
                            <span style="color: ${catMeta.color}">${catMeta.name}</span>
                        </span>
                        <span class="stat-pct">${stats.percentage}%</span>
                    </div>
                    <div class="bar-chart-track">
                        <div class="bar-chart-fill" style="width: ${stats.percentage}%; background-color: ${catMeta.color};"></div>
                    </div>
                </div>
            `;
        }
    }

    html += '</div>';
    content.innerHTML = html;

    // Show CTA if not complete
    if (completed < total) {
        cta.style.display = 'block';
    }
}

function renderPlayerSummary(data) {
    const section = document.getElementById('player-summary-section');
    const summary = data.player_summary;

    if (!summary) {
        section.style.display = 'none';
        return;
    }

    section.style.display = 'block';

    // Update skill badge
    const skillBadge = document.getElementById('skill-badge');
    const skillLevel = document.getElementById('skill-level');
    skillLevel.textContent = summary.skill_level.charAt(0).toUpperCase() + summary.skill_level.slice(1);

    // Color based on skill level
    const badgeColors = {
        'trivia master': '#22c55e',
        'trivia enthusiast': '#84cc16',
        'curious learner': '#eab308',
        'trivia rookie': '#f97316'
    };
    const badgeColor = badgeColors[summary.skill_level] || '#6b7280';
    skillBadge.style.background = `linear-gradient(135deg, ${badgeColor}22, ${badgeColor}44)`;
    skillBadge.style.borderColor = badgeColor;
    skillLevel.style.color = badgeColor;

    // Update stats
    document.getElementById('summary-questions').textContent = `${summary.total_questions} questions answered`;
    document.getElementById('summary-accuracy').textContent = `${summary.overall}% accuracy`;

    // Update text
    document.getElementById('summary-desc').textContent = summary.skill_desc;

    const strengthEl = document.getElementById('summary-strength');
    if (summary.strength_text) {
        strengthEl.textContent = summary.strength_text;
        strengthEl.style.display = 'block';
    } else {
        strengthEl.style.display = 'none';
    }

    const weaknessEl = document.getElementById('summary-weakness');
    if (summary.weakness_text) {
        weaknessEl.textContent = summary.weakness_text;
        weaknessEl.style.display = 'block';
    } else {
        weaknessEl.style.display = 'none';
    }

    // Render recommendations
    const recsSection = document.getElementById('recommendations-section');
    const recsGrid = document.getElementById('recommendations-grid');

    if (summary.recommendations && summary.recommendations.length > 0) {
        recsSection.style.display = 'block';
        recsGrid.innerHTML = summary.recommendations.map(rec => {
            const catColor = CATEGORIES[rec.category]?.color || '#888';

            // Icons for different types
            const icons = {
                'watch': `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>`,
                'read': `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>`,
                'listen': `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 18v-6a9 9 0 0 1 18 0v6"/><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"/></svg>`,
                'stream': `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="15" rx="2" ry="2"/><polyline points="17 2 12 7 7 2"/></svg>`
            };

            const typeLabels = {
                'watch': 'Watch',
                'read': 'Read',
                'listen': 'Listen',
                'stream': 'Stream'
            };

            const icon = icons[rec.type] || icons['read'];
            const typeLabel = typeLabels[rec.type] || 'Read';

            const linkContent = rec.url
                ? `<a href="${rec.url}" target="_blank" rel="noopener" class="rec-title">${rec.title}</a>`
                : `<span class="rec-title">${rec.title}</span>`;

            return `
                <div class="recommendation-card" style="border-left-color: ${catColor}">
                    <div class="rec-header">
                        <span class="rec-type" style="color: ${catColor}">${icon} ${typeLabel}</span>
                        <span class="rec-topic" style="background: ${catColor}22; color: ${catColor}">${rec.topic}</span>
                    </div>
                    ${linkContent}
                    <p class="rec-desc">${rec.desc}</p>
                </div>
            `;
        }).join('');
    } else {
        recsSection.style.display = 'none';
    }
}

function toggleGameRow(header) {
    const row = header.closest('.game-row');
    row.classList.toggle('expanded');
}

function toggleGame(header) {
    const card = header.closest('.game-card');
    card.classList.toggle('expanded');
}

async function shareGame(event, date, difficulty) {
    event.stopPropagation();

    const username = localStorage.getItem('uptriv_username');
    if (!username) return;

    try {
        const response = await fetch(`/api/get-share-text?username=${encodeURIComponent(username)}&date=${date}&difficulty=${difficulty}`);
        const data = await response.json();

        if (data.share_text) {
            await navigator.clipboard.writeText(data.share_text);
            showToast();
        }
    } catch (err) {
        console.error('Error sharing:', err);
    }
}

function showToast() {
    const toast = document.getElementById('share-toast');
    toast.classList.add('show');
    setTimeout(() => {
        toast.classList.remove('show');
    }, 2000);
}

// Initial load
loadHistory();
</script>
{% endblock %}
