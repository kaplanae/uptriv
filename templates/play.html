{% extends 'base.html' %}

{% block title %}Play - UpTriv{% endblock %}

{% block content %}
<div class="game-container">
    <!-- Login Screen (for unauthenticated users) -->
    <div id="login-screen" class="game-screen">
        <div class="login-card">
            <h2>Sign In to Play</h2>
            <p>Sign in with Google to track your progress and compete with friends</p>
            <a href="{{ url_for('google_login') }}" class="auth-btn login-btn" style="margin-top: 1rem; justify-content: center;">
                <svg width="18" height="18" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Sign In with Google
            </a>
        </div>
    </div>

    <!-- Ready Screen (for authenticated users) -->
    <div id="ready-screen" class="game-screen">
        <div class="login-card">
            <h2>Ready to Play<span id="player-name-wrapper">, <span id="player-name"></span></span>?</h2>
            <p>6 questions, 10 seconds each. Good luck!</p>

            <!-- Difficulty Toggle -->
            <div class="difficulty-toggle">
                <button class="difficulty-btn active" data-difficulty="easy" id="easy-btn">
                    <span class="diff-icon">ðŸŽ¯</span>
                    <span class="diff-label">Easy</span>
                </button>
                <button class="difficulty-btn" data-difficulty="hard" id="hard-btn">
                    <span class="diff-icon">ðŸ”¥</span>
                    <span class="diff-label">Hard</span>
                </button>
                <a href="{{ url_for('onboarding') }}" class="difficulty-btn profile-quiz-btn">
                    <span class="diff-icon">ðŸ§ </span>
                    <span class="diff-label">Profile Quiz</span>
                </a>
            </div>

            <button id="start-game-btn" class="play-button" style="margin: 1rem auto 0; display: flex;">
                <span>Start Game</span>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="5 3 19 12 5 21 5 3"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="game-screen active">
        <div class="login-card">
            <div class="spinner"></div>
            <p>Loading...</p>
        </div>
    </div>

    <!-- Countdown Screen -->
    <div id="countdown-screen" class="game-screen">
        <div class="countdown-display">
            <div class="countdown-number" id="countdown-number">3</div>
            <p>Get Ready!</p>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="game-screen">
        <div class="game-header">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="game-info">
                <div class="question-counter">
                    <span id="current-question">1</span> / <span id="total-questions">5</span>
                </div>
                <div class="category-badge" id="category-badge">
                    <span class="category-name" id="category-name">Category</span>
                </div>
                <div class="timer" id="timer">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    <span id="time-left">10</span>s
                </div>
            </div>
        </div>

        <div class="question-area">
            <h2 class="question-text" id="question-text">Loading question...</h2>
        </div>

        <div class="options-grid" id="options-grid">
            <!-- Options will be inserted here -->
        </div>

        <div class="answer-feedback" id="answer-feedback">
            <div class="feedback-content">
                <div class="feedback-icon" id="feedback-icon"></div>
                <p class="feedback-text" id="feedback-text"></p>
                <p class="correct-answer" id="correct-answer"></p>
            </div>
        </div>
    </div>

    <!-- Results Screen -->
    <div id="results-screen" class="game-screen">
        <div class="results-card">
            <h2>Game Complete!</h2>
            <div class="score-display">
                <div class="score-circle" id="score-circle">
                    <span class="score-number" id="score-number">0</span>
                    <span class="score-label">/ 6</span>
                </div>
            </div>
            <div class="results-breakdown" id="results-breakdown">
                <!-- Results will be inserted here -->
            </div>

            <!-- Hard Mode Prompt (shown to top performers) -->
            <div id="hard-mode-prompt" class="hard-mode-prompt" style="display: none;">
                <div class="prompt-content">
                    <span class="prompt-icon">ðŸ”¥</span>
                    <div class="prompt-text">
                        <strong>You're in the top 20%!</strong>
                        <p>Ready for a challenge? Try Hard Mode for tougher questions.</p>
                    </div>
                    <button id="try-hard-mode-btn" class="btn btn-danger btn-sm">Try Hard Mode</button>
                </div>
            </div>

            <div class="results-actions">
                <a href="{{ url_for('history') }}" class="btn btn-primary">View History</a>
                <p class="come-back">Come back tomorrow for new questions!</p>
            </div>
        </div>
    </div>

    <!-- Already Played Screen -->
    <div id="already-played-screen" class="game-screen">
        <div class="already-played-card">
            <div class="check-icon">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
            </div>
            <h2>You Already Played Today!</h2>
            <p id="already-played-message">New questions drop at midnight. Come back tomorrow!</p>

            <!-- Hard Mode Button -->
            <div id="play-hard-now" style="background: #fee2e2; border: 2px solid #ef4444; border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; text-align: center;">
                <p style="margin: 0 0 1rem 0; font-size: 1.1rem;">ðŸ”¥ <strong>Want a challenge?</strong> Try hard mode!</p>
                <button onclick="playHardModeNow()" style="background: #ef4444; color: white; border: none; padding: 0.875rem 2rem; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                    Play Hard Mode Now
                </button>
            </div>

            <!-- Difficulty Toggle for Tomorrow -->
            <div id="tomorrow-difficulty-section" class="tomorrow-difficulty">
                <p class="tomorrow-label">Difficulty for tomorrow:</p>
                <div class="difficulty-toggle">
                    <button class="difficulty-btn" data-difficulty="easy" id="ap-easy-btn">
                        <span class="diff-icon">ðŸŽ¯</span>
                        <span class="diff-label">Easy</span>
                    </button>
                    <button class="difficulty-btn" data-difficulty="hard" id="ap-hard-btn">
                        <span class="diff-icon">ðŸ”¥</span>
                        <span class="diff-label">Hard</span>
                    </button>
                </div>
            </div>

            <div class="already-played-actions">
                <a href="{{ url_for('history') }}" class="btn btn-primary">View History</a>
                <a href="{{ url_for('index') }}" class="btn btn-secondary">Go Home</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const QUESTION_TIME = 10;
const FEEDBACK_TIME = 1500;

let questions = [];
let currentQuestionIndex = 0;
let score = 0;
let timer = null;
let timeLeft = QUESTION_TIME;
let questionStartTime = null;
let results = [];
let currentUsername = null;
let anonymousId = null;
let isGoogleUser = false;
let currentDifficulty = 'easy';

// Difficulty toggle handling
document.querySelectorAll('.difficulty-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
        const difficulty = btn.dataset.difficulty;
        if (difficulty === currentDifficulty) return;

        // Update UI
        document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentDifficulty = difficulty;

        // Save to server
        try {
            await fetch('/api/set-difficulty', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ difficulty, anonymous_id: anonymousId })
            });
        } catch (e) {
            console.error('Error setting difficulty:', e);
        }
    });
});

// Load user's difficulty setting
async function loadDifficulty() {
    try {
        const url = anonymousId
            ? `/api/get-difficulty?anonymous_id=${encodeURIComponent(anonymousId)}`
            : '/api/get-difficulty';
        const res = await fetch(url);
        const data = await res.json();
        currentDifficulty = data.difficulty || 'easy';

        // Update UI
        document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`[data-difficulty="${currentDifficulty}"]`).classList.add('active');
    } catch (e) {
        console.error('Error loading difficulty:', e);
    }
}

// Screen management
function showScreen(screenId) {
    document.querySelectorAll('.game-screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
}

// Get or create anonymous session
async function getOrCreateSession() {
    // Check localStorage for existing anonymous_id
    anonymousId = localStorage.getItem('uptriv_anonymous_id');

    try {
        const res = await fetch('/api/anonymous-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ anonymous_id: anonymousId })
        });
        const data = await res.json();

        if (data.success) {
            anonymousId = data.anonymous_id;
            localStorage.setItem('uptriv_anonymous_id', anonymousId);
            localStorage.setItem('uptriv_username', data.username);
            return { username: data.username, user_id: data.user_id };
        }
        console.error('Anonymous session failed:', data.error);
        return null;
    } catch (e) {
        console.error('Error creating anonymous session:', e);
        return null;
    }
}

// Check authentication and initialize
async function initGame() {
    try {
        // First check if logged in via Google
        const res = await fetch('/api/me');
        const data = await res.json();

        if (data.authenticated) {
            // Google user - show their name
            currentUsername = data.user.username;
            isGoogleUser = true;
            document.getElementById('player-name').textContent = currentUsername;
            document.getElementById('player-name-wrapper').style.display = 'inline';
            localStorage.setItem('uptriv_username', currentUsername);
            await loadDifficulty();
            showScreen('ready-screen');
        } else {
            // Anonymous user - create or get session, hide name
            const session = await getOrCreateSession();
            if (session) {
                currentUsername = session.username;
                document.getElementById('player-name-wrapper').style.display = 'none';
                await loadDifficulty();
                showScreen('ready-screen');
            } else {
                // Fallback to login screen if session creation fails
                showScreen('login-screen');
            }
        }
    } catch (e) {
        console.error('Error checking auth:', e);
        // Try anonymous session as fallback
        try {
            const session = await getOrCreateSession();
            if (session) {
                currentUsername = session.username;
                document.getElementById('player-name-wrapper').style.display = 'none';
                await loadDifficulty();
                showScreen('ready-screen');
            } else {
                showScreen('login-screen');
            }
        } catch (e2) {
            showScreen('login-screen');
        }
    }
}

// Start game button
document.getElementById('start-game-btn').addEventListener('click', async () => {
    try {
        const response = await fetch('/api/start-game', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ anonymous_id: anonymousId })
        });

        const data = await response.json();

        if (data.error === 'already_played') {
            await loadDifficulty();
            initAlreadyPlayedDifficulty();

            // Hide hard mode option if already played hard
            if (data.played_difficulties && data.played_difficulties.includes('hard')) {
                document.getElementById('play-hard-now').style.display = 'none';
            }

            showScreen('already-played-screen');
            return;
        }

        if (data.require_session) {
            // Try to recreate session
            const session = await getOrCreateSession();
            if (session) {
                // Retry start game
                document.getElementById('start-game-btn').click();
            } else {
                showScreen('login-screen');
            }
            return;
        }

        if (data.error) {
            alert(data.message || data.error);
            return;
        }

        questions = data.questions;
        startCountdown();
    } catch (err) {
        console.error(err);
        alert('Error starting game: ' + err.message);
    }
});

// Initialize on page load
initGame();

function startCountdown() {
    showScreen('countdown-screen');
    let count = 3;
    const countdownEl = document.getElementById('countdown-number');
    countdownEl.textContent = count;

    const interval = setInterval(() => {
        count--;
        if (count > 0) {
            countdownEl.textContent = count;
            countdownEl.classList.add('pulse');
            setTimeout(() => countdownEl.classList.remove('pulse'), 300);
        } else {
            clearInterval(interval);
            startGame();
        }
    }, 1000);
}

function startGame() {
    showScreen('game-screen');
    currentQuestionIndex = 0;
    score = 0;
    results = [];
    showQuestion();
}

function showQuestion() {
    const q = questions[currentQuestionIndex];

    // Update UI
    document.getElementById('current-question').textContent = currentQuestionIndex + 1;
    document.getElementById('total-questions').textContent = questions.length;
    document.getElementById('category-name').textContent = q.category_name;
    document.getElementById('category-badge').style.setProperty('--cat-color', q.color);
    document.getElementById('question-text').textContent = q.question;

    // Update progress bar
    const progress = (currentQuestionIndex / questions.length) * 100;
    document.getElementById('progress-fill').style.width = `${progress}%`;

    // Create options
    const optionsGrid = document.getElementById('options-grid');
    optionsGrid.innerHTML = '';

    // Shuffle options
    const shuffledOptions = [...q.options].sort(() => Math.random() - 0.5);

    shuffledOptions.forEach((option, i) => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.textContent = option;
        btn.style.animationDelay = `${i * 0.1}s`;
        btn.addEventListener('click', () => selectAnswer(option));
        optionsGrid.appendChild(btn);
    });

    // Hide feedback
    document.getElementById('answer-feedback').classList.remove('show', 'correct', 'incorrect');

    // Start timer
    timeLeft = QUESTION_TIME;
    questionStartTime = Date.now();
    updateTimerDisplay();
    timer = setInterval(updateTimer, 100);
}

function updateTimer() {
    const elapsed = (Date.now() - questionStartTime) / 1000;
    timeLeft = Math.max(0, QUESTION_TIME - elapsed);
    updateTimerDisplay();

    if (timeLeft <= 0) {
        clearInterval(timer);
        selectAnswer(null); // Time's up
    }
}

function updateTimerDisplay() {
    const timerEl = document.getElementById('time-left');
    timerEl.textContent = Math.ceil(timeLeft);

    // Change color when low
    const timerContainer = document.getElementById('timer');
    if (timeLeft <= 3) {
        timerContainer.classList.add('danger');
    } else {
        timerContainer.classList.remove('danger');
    }
}

async function selectAnswer(answer) {
    clearInterval(timer);
    const timeTaken = QUESTION_TIME - timeLeft;

    // Disable all options
    document.querySelectorAll('.option-btn').forEach(btn => {
        btn.disabled = true;
        if (btn.textContent === answer) {
            btn.classList.add('selected');
        }
    });

    // Submit answer
    try {
        const response = await fetch('/api/submit-answer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                question_index: currentQuestionIndex,
                answer: answer,
                time_taken: timeTaken,
                anonymous_id: anonymousId
            })
        });

        const data = await response.json();
        const correct = data.correct;

        // Store result
        results.push({
            category: questions[currentQuestionIndex].category_name,
            color: questions[currentQuestionIndex].color,
            correct: correct
        });

        if (correct) score++;

        // Show correct/incorrect on options
        document.querySelectorAll('.option-btn').forEach(btn => {
            if (btn.textContent === data.correct_answer) {
                btn.classList.add('correct');
            } else if (btn.textContent === answer && !correct) {
                btn.classList.add('incorrect');
            }
        });

        // Store percentage for results
        results[results.length - 1].percent_correct = data.percent_correct;
        results[results.length - 1].total_answers = data.total_answers;

        // Show feedback with percentage
        showFeedback(correct, data.correct_answer, answer === null, data.percent_correct);

    } catch (err) {
        console.error('Error submitting answer:', err);
        // Still show feedback and move to next question on error
        showFeedback(false, 'Error', false, null);
    }
}

function showFeedback(correct, correctAnswer, timedOut, percentCorrect) {
    const feedback = document.getElementById('answer-feedback');
    const icon = document.getElementById('feedback-icon');
    const text = document.getElementById('feedback-text');
    const correctEl = document.getElementById('correct-answer');

    let percentText = '';
    if (percentCorrect !== null) {
        percentText = `<span class="percent-stat">${percentCorrect}% of players got this right</span>`;
    }

    if (correct) {
        feedback.classList.add('correct');
        icon.innerHTML = '<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>';
        text.textContent = 'Correct!';
        correctEl.innerHTML = percentText;
    } else {
        feedback.classList.add('incorrect');
        icon.innerHTML = '<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
        text.textContent = timedOut ? "Time's up!" : 'Incorrect';
        correctEl.innerHTML = `Answer: ${correctAnswer}${percentText ? '<br>' + percentText : ''}`;
    }

    feedback.classList.add('show');

    setTimeout(() => {
        feedback.classList.remove('show', 'correct', 'incorrect');
        nextQuestion();
    }, FEEDBACK_TIME);
}

function nextQuestion() {
    currentQuestionIndex++;

    if (currentQuestionIndex >= questions.length) {
        showResults();
    } else {
        showQuestion();
    }
}

function showResults() {
    showScreen('results-screen');

    // Update score
    document.getElementById('score-number').textContent = score;

    // Color the score circle based on performance
    const scoreCircle = document.getElementById('score-circle');
    if (score === 6) {
        scoreCircle.classList.add('perfect');
    } else if (score >= 4) {
        scoreCircle.classList.add('good');
    } else {
        scoreCircle.classList.add('needs-work');
    }

    // Show breakdown with percentages
    const breakdown = document.getElementById('results-breakdown');
    breakdown.innerHTML = '';

    results.forEach((r, i) => {
        const item = document.createElement('div');
        item.className = `result-item ${r.correct ? 'correct' : 'incorrect'}`;
        item.style.animationDelay = `${i * 0.1}s`;
        const pct = r.percent_correct || 0;
        item.innerHTML = `
            <div class="result-main">
                <span class="result-category" style="color: ${r.color}">${r.category}</span>
                <span class="result-icon">${r.correct ? 'âœ“' : 'âœ—'}</span>
            </div>
            <span class="result-percent">${pct}% got it right</span>
        `;
        breakdown.appendChild(item);
    });

    // Check if user qualifies for hard mode (only for easy mode players)
    if (currentDifficulty === 'easy') {
        checkHardModeEligibility();
    }
}

async function checkHardModeEligibility() {
    try {
        const url = anonymousId
            ? `/api/check-hard-mode-eligibility?anonymous_id=${encodeURIComponent(anonymousId)}`
            : '/api/check-hard-mode-eligibility';
        const res = await fetch(url);
        const data = await res.json();

        if (data.eligible) {
            document.getElementById('hard-mode-prompt').style.display = 'block';
        }
    } catch (e) {
        console.error('Error checking hard mode eligibility:', e);
    }
}

// Already-played screen difficulty toggle
document.querySelectorAll('#already-played-screen .difficulty-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
        const difficulty = btn.dataset.difficulty;
        if (difficulty === currentDifficulty) return;

        // Update UI
        document.querySelectorAll('#already-played-screen .difficulty-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentDifficulty = difficulty;

        // Save to server
        try {
            await fetch('/api/set-difficulty', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ difficulty, anonymous_id: anonymousId })
            });
        } catch (e) {
            console.error('Error setting difficulty:', e);
        }
    });
});

// Initialize already-played screen difficulty buttons when shown
function initAlreadyPlayedDifficulty() {
    document.querySelectorAll('#already-played-screen .difficulty-btn').forEach(b => b.classList.remove('active'));
    const activeBtn = document.querySelector(`#already-played-screen [data-difficulty="${currentDifficulty}"]`);
    if (activeBtn) activeBtn.classList.add('active');
}

// Play Hard Mode Now function (called directly from button onclick)
async function playHardModeNow() {
    try {
        // Switch to hard mode
        const setDiffRes = await fetch('/api/set-difficulty', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ difficulty: 'hard', anonymous_id: anonymousId })
        });

        if (!setDiffRes.ok) {
            alert('Failed to set difficulty. Please try again.');
            return;
        }

        // Update local state
        currentDifficulty = 'hard';

        // Start the game
        const response = await fetch('/api/start-game', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ anonymous_id: anonymousId })
        });

        const data = await response.json();

        if (data.error === 'already_played') {
            alert(data.message || "You've already played today! Come back tomorrow.");
            return;
        }

        if (data.error) {
            alert(data.message || data.error);
            return;
        }

        questions = data.questions;
        startCountdown();
    } catch (e) {
        console.error('Error in playHardModeNow:', e);
        alert('Hard mode failed: ' + e.message);
    }
}

// Hard mode button handler
document.getElementById('try-hard-mode-btn').addEventListener('click', async () => {
    try {
        await fetch('/api/set-difficulty', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ difficulty: 'hard', anonymous_id: anonymousId })
        });
        // Update local state
        currentDifficulty = 'hard';
        document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
        document.querySelector('[data-difficulty="hard"]').classList.add('active');

        // Hide the prompt and show confirmation
        const prompt = document.getElementById('hard-mode-prompt');
        prompt.innerHTML = `
            <div class="prompt-content confirmed">
                <span class="prompt-icon">ðŸ”¥</span>
                <div class="prompt-text">
                    <strong>Hard Mode Activated!</strong>
                    <p>Tomorrow's questions will be more challenging.</p>
                </div>
            </div>
        `;
    } catch (e) {
        console.error('Error setting hard mode:', e);
    }
});
</script>
{% endblock %}
